<!DOCTYPE html>
<html>
<head>
	<title>dog-walking</title>
	<style type="text/css">
		#dog-walking{
			position: fixed;
			left: 0;
			bottom: 0;
		}
	</style>
</head>
<body>
	<canvas id="dog-walking"></canvas>
	<img src="images/dog_07.png">
	<script type="text/javascript">
		let img = new Image();
		img.onload = function(){
			beginDraw(img);
		}
		img.src = 'images/dog_01.png';

		class DogAnimation{
			constructor(canvas){

				this.canvas = canvas;
				this.ctx = canvas.getContext("2d");
				this.lastWalking = Date.now();
				this.keyFrameIndex = -1;
				this.dogPictures = [];
				this.RES_PATH = './images';
				this.IMG_COUNT = 8;
				this.start();
			}
			async start(){
				await this.loadResourses();
				window.requestAnimationFrame(this.walk.bind(this));
			}
			walk(){
				let now = Date.now();
				if (now - this.lastWalking > 100) {
					this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
			        // 获取下一张图片的索引
			        let keyFrameIndex = ++this.keyFrameIndex % this.IMG_COUNT;
			        let img = this.dogPictures[keyFrameIndex + 1]; 
			                        // img, sx, sy, swidth, sheight
			        this.ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight,
			                // dx = 20, dy, dwidth, dheight
			                20, 20, 186, 162); 
			        this.lastWalking = now;
				}
				window.requestAnimationFrame(this.walk.bind(this));
			}
			loadResourses(){
				let imagesPath = [];

				for (let i = 0; i <= this.IMG_COUNT; i++) {
					imagesPath.push(`${this.RES_PATH}/dog_0${i}.png`);
				}
				let works = [];
				imagesPath.forEach(imgPath=>{
					works.push(new Promise(resolve=>{
						let img = new Image();
						img.onload = ()=>resolve(img);
						img.src = imgPath;
					}));
				});

				return new Promise(resolve =>{
					Promise.all(works).then(dogPictures=>{
						this.dogPictures = dogPictures;
						resolve();
					})
				})
			}
		}
		let canvas = document.querySelector("#dog-walking");
		canvas.width = window.innerWidth;
		canvas.height = 200;
		let dogAnimation = new DogAnimation(canvas);
		dogAnimation.start();


	</script>
</body>
</html>